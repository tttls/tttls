<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>恋爱·同同♥静静</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        love: {
                            pink: '#ff99cc',
                            deepPink: '#ff1493',
                            lightPink: '#ffb6c1',
                            purple: '#9370db',
                            bg: '#0f0010',
                            progress: '#ff69b4',
                            button: '#501a23'
                        }
                    },
                    fontFamily: {
                        sans: ['SimHei', 'WenQuanYi Micro Hei', 'Heiti TC', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }
            .heart-beat {
                animation: heartbeat 1.5s ease-in-out infinite;
            }
            .float {
                animation: float 6s ease-in-out infinite;
            }
            .photo-hover {
                transition: all 0.3s ease;
            }
            .photo-hover:hover {
                transform: scale(1.05) rotate(2deg);
                z-index: 20;
            }
            .card-expand {
                transition: max-height 0.5s ease, opacity 0.5s ease, transform 0.5s ease;
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.1); }
            28% { transform: scale(1); }
            42% { transform: scale(1.1); }
            70% { transform: scale(1); }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #loveCanvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        #musicController {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        #daysCounter {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        /* 音乐播放器容器样式 */
        #musicPlayerContainer {
            transition: all 0.3s ease;
            max-width: 90vw; /* 限制最大宽度 */
        }

        #musicPlayerContainer:hover {
            transform: translateY(-5px);
        }

        /* 隐藏原生音频控件 */
        #backgroundMusic {
            display: none;
        }

        /* 照片墙样式 */
        #photoWall {
            transition: all 0.5s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        #photoWall.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* 爱情宣言卡片 */
        #loveLetterCard {
            cursor: pointer;
        }

        #letterContent {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
        }

        #loveLetterCard.expanded #letterContent {
            max-height: 500px;
            opacity: 1;
            transform: translateY(0);
        }

        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }

        /* 移动端音乐播放器加载提示 */
        #musicLoading {
            display: none;
            color: white;
            text-align: center;
            padding: 10px;
        }

        /* 移动端适配 */
        @media (max-width: 640px) {
            #musicPlayerContainer {
                width: calc(100% - 20px);
                bottom: 60px; /* 调整底部位置 */
            }
            
            #musicPlayerContainer iframe {
                width: 100% !important;
                height: 300px !important; /* 减小高度 */
            }
            
            /* 移动端备用播放器 */
            #mobileAudioPlayer {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 10px;
                color: white;
            }
        }

        /* 桌面端隐藏备用播放器 */
        @media (min-width: 641px) {
            #mobileAudioPlayer {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-love-bg m-0 p-0 h-screen overflow-x-hidden">
    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-love-bg z-200">
        <div class="text-love-pink text-center">
            <i class="fa fa-heart heart-beat text-5xl mb-4"></i>
            <p>加载中...</p>
        </div>
    </div>

    <canvas id="loveCanvas"></canvas>

    <!-- 顶部导航 -->
    <nav class="fixed top-0 left-0 right-0 bg-love-button bg-opacity-70 backdrop-blur-sm z-95 flex justify-center py-2">
        <div class="flex space-x-4 text-white text-sm md:text-base">
            <a href="#heart" class="px-3 py-1 rounded hover:bg-love-pink hover:bg-opacity-30 transition-all">心形区域</a>
            <a href="#photos" class="px-3 py-1 rounded hover:bg-love-pink hover:bg-opacity-30 transition-all">我们的回忆</a>
            <a href="#letter" class="px-3 py-1 rounded hover:bg-love-pink hover:bg-opacity-30 transition-all">爱情宣言</a>
        </div>
    </nav>

    <!-- 恋爱天数计数器 -->
    <div id="daysCounter" class="fixed top-12 left-1/2 transform -translate-x-1/2 bg-love-button bg-opacity-60 text-white px-4 py-2 rounded-full z-90 text-center">
        <p class="text-sm md:text-base"><span id="daysCount">0</span> 天的幸福时光</p>
    </div>

    <!-- 主心形区域 -->
    <section id="heart" class="h-screen relative flex items-center justify-center">
        <!-- 内容在这里由Canvas渲染 -->
    </section>

    <!-- 照片墙区域 -->
    <section id="photos" class="py-16 px-4 relative">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-love-pink text-center text-3xl mb-10 font-bold heart-beat">我们的回忆</h2>
            
            <div id="photoWall" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                <!-- 照片将通过JavaScript动态添加 -->
            </div>
            
            <div class="text-center mt-8">
                <button id="addPhotoBtn" class="bg-love-deepPink hover:bg-love-pink text-white px-6 py-2 rounded-full transition-all flex items-center mx-auto">
                    <i class="fa fa-plus mr-2"></i> 添加照片
                </button>
                <input type="file" id="photoInput" accept="image/*" class="hidden" multiple>
            </div>
        </div>
    </section>

    <!-- 爱情宣言区域 -->
    <section id="letter" class="py-16 px-4 relative">
        <div class="max-w-3xl mx-auto">
            <h2 class="text-love-pink text-center text-3xl mb-10 font-bold heart-beat">爱情宣言</h2>
            
            <div id="loveLetterCard" class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 border-2 border-love-pink card-expand">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-love-lightPink text-xl font-bold">给我最爱的人</h3>
                    <i id="letterToggle" class="fa fa-chevron-down text-love-pink transition-transform duration-300"></i>
                </div>
                
                <div id="letterContent" class="card-expand text-white space-y-4">
                    <p>亲爱的静静：</p>
                    <p>从2025年9月14日那天起，我的世界因为有你而变得更加精彩。每一天和你在一起的时光，都是我生命中最珍贵的礼物。</p>
                    <p>你的笑容像阳光一样温暖，你的拥抱像港湾一样安心。无论是欢声笑语还是默默相伴，有你的日子就是最好的日子。</p>
                    <p>我爱你，不仅因为你是谁，也因为和你在一起时我是谁。愿我们的爱情如同这漫天星光，永远闪耀，直到永远。</p>
                    <p class="text-right mt-6">永远爱你的同同</p>
                    
                    <div class="mt-6 pt-4 border-t border-love-pink border-opacity-30">
                        <button id="editLetterBtn" class="bg-love-purple hover:bg-love-pink text-white px-4 py-2 rounded transition-all text-sm">
                            <i class="fa fa-pencil mr-1"></i> 编辑我的宣言
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 底部留白 -->
    <div class="h-32"></div>

    <!-- 网易云音乐iframe播放器 -->
    <div id="musicPlayerContainer" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-90 bg-love-button bg-opacity-80 p-2 rounded-lg shadow-lg">
        <!-- 加载提示 -->
        <div id="musicLoading">
            <i class="fa fa-spinner fa-spin"></i> 加载音乐播放器中...
        </div>
        
        <!-- 网易云音乐iframe -->
        <iframe
            id="musicIframe"
            frameborder="no"
            border="0"
            marginwidth="0"
            marginheight="0"
            width="280"
            height="52"
            src="//music.163.com/outchain/player?type=0&id=14319654515&auto=1&height=430"
            title="网易云音乐播放器"
            onload="hideMusicLoading()"
            onerror="showMusicError()"
        >
        </iframe>
        
        <!-- 移动端备用音频播放器 -->
        <div id="mobileAudioPlayer" class="hidden">
            <audio controls id="mobileAudio" class="w-full">
                <source src="https://music.163.com/song/media/outer/url?id=14319654515.mp3" type="audio/mpeg">
                您的浏览器不支持音频播放
            </audio>
        </div>
    </div>

    <!-- 音乐控制器 -->
    <div id="musicController" class="bg-opacity-50 bg-love-button text-white p-3 flex items-center justify-between">
        <button id="togglePlayerBtn" class="w-10 h-10 rounded-full bg-love-deepPink flex items-center justify-center">
            <i class="fa fa-music"></i>
        </button>

        <div class="flex-grow mx-3 text-center text-sm hidden md:block">
            <span>点击左侧音乐按钮可关闭歌单 || 静静老婆爱你爱你 || 点击右侧烟花可发射爱的烟花</span>
        </div>
        <div class="flex-grow mx-3 text-center text-xs md:hidden">
            <span>音乐 | 爱你 | 烟花</span>
        </div>

        <div class="flex items-center">
            <button id="fireworkBtn" class="ml-2 px-3 py-1 bg-love-pink rounded text-xs">
                烟花
            </button>
            <!-- 本地音乐上传功能 -->
            <label for="localMusic" class="ml-2 px-3 py-1 bg-love-purple rounded text-xs cursor-pointer">
                本地音乐
            </label>
            <input id="localMusic" type="file" accept="audio/mp3" class="hidden">
        </div>
    </div>

    <audio id="backgroundMusic" loop>
        <source src="" type="audio/mpeg">
    </audio>

    <script>
        // 音乐播放器加载状态管理
        function hideMusicLoading() {
            document.getElementById('musicLoading').style.display = 'none';
            document.getElementById('musicIframe').style.display = 'block';
        }
        
        function showMusicError() {
            // 如果iframe加载失败，在移动端显示备用播放器
            if (window.innerWidth <= 640) {
                document.getElementById('musicLoading').style.display = 'none';
                document.getElementById('musicIframe').style.display = 'none';
                document.getElementById('mobileAudioPlayer').style.display = 'block';
            } else {
                document.getElementById('musicLoading').innerHTML = 
                    '<div class="text-red-300">播放器加载失败，请尝试刷新页面</div>';
            }
        }
        
        // 页面加载时检查是否为移动端，如果是则使用不同的加载策略
        window.addEventListener('load', function() {
            if (window.innerWidth <= 640) {
                // 移动端延迟加载iframe，提高优先级
                setTimeout(function() {
                    const iframe = document.getElementById('musicIframe');
                    iframe.src = iframe.src; // 触发重新加载
                }, 1000);
            }
        });

        // 基本错误处理
        window.addEventListener('error', (e) => {
            console.error('发生错误:', e.error);
            alert('页面加载出错: ' + e.error.message);
        });

        // 恋爱纪念日 - 2025年9月14日
        const LOVE_START_DATE = new Date(2025, 8, 14); // 月份从0开始计数
        
        // 计算恋爱天数
        function calculateLoveDays() {
            const today = new Date();
            const timeDiff = today - LOVE_START_DATE;
            const dayDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            document.getElementById('daysCount').textContent = dayDiff;
        }
        
        // 初始化计算并每分钟更新一次
        calculateLoveDays();
        setInterval(calculateLoveDays, 60000);

        // 获取画布和上下文
        const canvas = document.getElementById('loveCanvas');
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error('无法获取Canvas上下文');
            alert('您的浏览器不支持Canvas，无法运行此应用');
        }

        // 元素获取
        const audio = document.getElementById('backgroundMusic');
        const loader = document.getElementById('loader');
        const fireworkBtn = document.getElementById('fireworkBtn');
        const togglePlayerBtn = document.getElementById('togglePlayerBtn');
        const musicPlayerContainer = document.getElementById('musicPlayerContainer');
        const localMusicInput = document.getElementById('localMusic');
        const photoWall = document.getElementById('photoWall');
        const addPhotoBtn = document.getElementById('addPhotoBtn');
        const photoInput = document.getElementById('photoInput');
        const loveLetterCard = document.getElementById('loveLetterCard');
        const letterToggle = document.getElementById('letterToggle');
        const editLetterBtn = document.getElementById('editLetterBtn');

        // 响应式画布尺寸
        function resizeCanvas() {
            try {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                bigHeartPoints = getHeartPoints(BIG_HEART_SCALE);
                borderHearts = createBorderHearts();
                initWordBlocks();
                console.log(`画布已调整大小: ${canvas.width}x${canvas.height}`);
            } catch (e) {
                console.error('调整画布大小时出错:', e);
            }
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // 颜色定义
        const COLORS = {
            white: '#ffffff',
            red: '#ff0000',
            pink: '#ff99cc',
            deepPink: '#ff1493',
            lightPink: '#ffb6c1',
            purple: '#9370db'
        };

        // 烟花颜色
        const FIREWORK_COLORS = [
            [255, 50, 50], [255, 150, 50], [255, 255, 50],
            [50, 255, 50], [50, 150, 255], [150, 50, 255],
            [255, 50, 150], [255, 255, 255]
        ];

        // 大桃心参数
        const BIG_HEART_SCALE = Math.min(window.innerWidth, window.innerHeight) / 30;
        let bigHeartPoints = getHeartPoints(BIG_HEART_SCALE);

        // 计算心形点
        function getHeartPoints(scale = 1, xOffset = 0, yOffset = 0) {
            try {
                const points = [];
                for (let angle = 0; angle < 360; angle += 2) {
                    const t = angle * Math.PI / 180;
                    const x = 16 * Math.sin(t) ** 3;
                    const y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);

                    points.push({
                        x: x * scale + canvas.width / 2 + xOffset,
                        y: -y * scale + canvas.height / 2 + yOffset
                    });
                }
                return points;
            } catch (e) {
                console.error('计算心形点时出错:', e);
                return [];
            }
        }

        // 检查点是否在桃心内部
        function isInsideHeart(x, y, heartPoints) {
            let inside = false;
            for (let i = 0, j = heartPoints.length - 1; i < heartPoints.length; j = i++) {
                const xi = heartPoints[i].x, yi = heartPoints[i].y;
                const xj = heartPoints[j].x, yj = heartPoints[j].y;

                const intersect = ((yi > y) !== (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi + 0.0001) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        // 边框小桃心类
        class BorderHeart {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 15 + 5;
                this.color = this.getRandomColor();
                this.pulse = Math.random() * Math.PI * 2;
                this.pulseSpeed = Math.random() * 0.03 + 0.02;
                this.rotation = 0;
                this.rotationSpeed = Math.random() * 1 - 0.5;
            }

            getRandomColor() {
                const colors = [
                    COLORS.red, COLORS.pink, COLORS.deepPink,
                    COLORS.purple, '#ff3232', '#ff96c8'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            update() {
                this.pulse += this.pulseSpeed;
                this.currentSize = this.size + Math.sin(this.pulse) * 2;
                this.rotation += this.rotationSpeed;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation * Math.PI / 180);

                ctx.beginPath();
                const points = [];
                for (let angle = 0; angle < 360; angle += 5) {
                    const t = angle * Math.PI / 180;
                    const x = 16 * Math.sin(t) ** 3;
                    const y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
                    points.push({
                        x: x * this.currentSize / 16,
                        y: -y * this.currentSize / 16
                    });
                }

                ctx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                ctx.closePath();
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.strokeStyle = COLORS.white;
                ctx.lineWidth = 1;
                ctx.stroke();
                ctx.restore();
            }
        }

        // 创建边框桃心
        function createBorderHearts() {
            return bigHeartPoints.map(point => new BorderHeart(point.x, point.y));
        }

        let borderHearts = createBorderHearts();

        // 内部桃心粒子类
        class InnerHeart {
            constructor() {
                const angle = Math.random() * Math.PI * 2;
                const t = angle;
                let x = 16 * Math.sin(t) ** 3;
                let y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);

                this.x = x * (BIG_HEART_SCALE * 0.8) / 16 + canvas.width / 2;
                this.y = -y * (BIG_HEART_SCALE * 0.8) / 16 + canvas.height / 2;

                this.size = Math.random() * 7 + 5;
                this.color = this.getRandomColor();
                this.speedX = Math.random() * 1 - 0.5;
                this.speedY = Math.random() * 1 - 0.5;
                this.life = Math.random() * 120 + 60;
                this.alpha = 1;
            }

            getRandomColor() {
                const colors = [
                    COLORS.red, COLORS.pink, COLORS.deepPink,
                    COLORS.purple, '#ff3232', '#ff96c8'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                if (!isInsideHeart(this.x, this.y, bigHeartPoints)) {
                    this.speedX *= -0.8;
                    this.speedY *= -0.8;
                    this.x += this.speedX;
                    this.y += this.speedY;
                }

                this.life -= 1;
                this.alpha = this.life / 180;
                return this.life > 0;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.translate(this.x, this.y);

                ctx.beginPath();
                const points = [];
                for (let angle = 0; angle < 360; angle += 5) {
                    const t = angle * Math.PI / 180;
                    const x = 16 * Math.sin(t) ** 3;
                    const y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
                    points.push({
                        x: x * this.size / 16,
                        y: -y * this.size / 16
                    });
                }

                ctx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                ctx.closePath();
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.restore();
            }
        }

        let innerHearts = [];

        // 动态字块类
        class WordBlock {
            constructor(text, baseSize) {
                this.text = text;
                this.baseSize = baseSize;
                this.color = this.getRandomColor();
                this.resetPosition();

                // 飘动速度
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;

                this.pulse = Math.random() * Math.PI * 2;
                this.pulseSpeed = Math.random() * 0.05 + 0.01;
                this.fade = Math.random() * Math.PI * 2;
                this.fadeSpeed = Math.random() * 0.03 + 0.01;
            }

            resetPosition() {
                const angle = Math.random() * Math.PI * 2;
                const t = angle;
                let x = 16 * Math.sin(t) ** 3;
                let y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);

                this.x = x * (BIG_HEART_SCALE * 0.7) / 16 + canvas.width / 2;
                this.y = -y * (BIG_HEART_SCALE * 0.7) / 16 + canvas.height / 2;
            }

            getRandomColor() {
                const colors = [
                    COLORS.red, COLORS.pink, COLORS.deepPink,
                    COLORS.purple, '#ff3232', '#ff96c8'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            update() {
                this.pulse += this.pulseSpeed;
                const scale = 1 + Math.sin(this.pulse) * 0.4;
                this.currentSize = this.baseSize * scale;

                this.fade += this.fadeSpeed;
                this.alpha = 0.7 + 0.3 * Math.sin(this.fade);

                this.x += this.speedX;
                this.y += this.speedY;

                if (!isInsideHeart(this.x, this.y, bigHeartPoints)) {
                    const bounceAngle = Math.random() * Math.PI * 0.5 + Math.PI * 0.25;
                    const speed = Math.sqrt(this.speedX **2 + this.speedY** 2);

                    this.speedX = speed * Math.cos(bounceAngle) * (this.x < canvas.width / 2 ? 1 : -1);
                    this.speedY = speed * Math.sin(bounceAngle) * (this.y < canvas.height / 2 ? 1 : -1);

                    this.x += this.speedX * 2;
                    this.y += this.speedY * 2;
                }

                if (Math.random() < 0.03) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 0.5;
                    this.speedX = Math.cos(angle) * speed;
                    this.speedY = Math.sin(angle) * speed;
                }
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;

                // 绘制阴影
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.font = `bold ${this.currentSize}px SimHei, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.text, this.x + 2, this.y + 2);

                // 绘制文字
                ctx.fillStyle = this.color;
                ctx.fillText(this.text, this.x, this.y);

                ctx.restore();
            }
        }

        // 初始化文字块
        let wordBlocks = [];
        function initWordBlocks() {
            wordBlocks = [
                new WordBlock("ztt", Math.min(50, canvas.width / 12)),
                new WordBlock("love", Math.min(60, canvas.width / 10)),
                new WordBlock("ljx", Math.min(50, canvas.width / 12)),
                new WordBlock("forever", Math.min(55, canvas.width / 11)),
                new WordBlock("静静", Math.min(60, canvas.width / 10)),
                new WordBlock("同同", Math.min(55, canvas.width / 12)),
                new WordBlock("ztt", Math.min(40, canvas.width / 12)),
                new WordBlock("love", Math.min(35, canvas.width / 10)),
                new WordBlock("ljx", Math.min(25, canvas.width / 12)),
                new WordBlock("forever", Math.min(40, canvas.width / 11)),
                new WordBlock("静静", Math.min(50, canvas.width / 10)),
                new WordBlock("同同", Math.min(35, canvas.width / 12)),
                new WordBlock("一生一世", Math.min(35, canvas.width / 12))
            ];
        }
        initWordBlocks();

        // 纪念日文字
        class AnniversaryText {
            constructor(text, baseSize) {
                this.text = text;
                this.baseSize = baseSize;
                this.size = Math.min(baseSize, window.innerHeight / 15);
                this.color = COLORS.pink;
                this.fade = 0;
                this.fadeSpeed = 0.02;
            }

            update() {
                this.fade += this.fadeSpeed;
                this.alpha = 0.85 + 0.15 * Math.sin(this.fade);
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;

                ctx.fillStyle = 'rgba(50, 0, 30, 0.6)';
                ctx.font = `bold ${this.size}px SimHei, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                const yPos = Math.max(50, canvas.height  / 2 - canvas.height  /  2 );
                ctx.fillText(this.text, canvas.width / 2 + 3, yPos + 3);

                ctx.fillStyle = this.color;
                ctx.fillText(this.text, canvas.width / 2, yPos);

                ctx.restore();
            }
        }

        const annivText = new AnniversaryText("恋爱纪念20250914", 50);

        // 烟花效果
        class FireworkParticle {
            constructor(x, y, color, sizeFactor = 1.0) {
                this.x = x;
                this.y = y;
                this.color = [...color];
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 * sizeFactor + 1 * sizeFactor;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.gravity = 0.05 * sizeFactor;
                this.life = Math.random() * 60 + 40;
                this.maxLife = this.life;
                this.flicker = Math.random() * Math.PI * 2;
                this.baseSize = Math.random() * 2.5 + 1.5 * sizeFactor;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += this.gravity;
                this.vx *= 0.97;
                this.vy *= 0.97;
                this.life -= 1;
                this.flicker += 0.1;
                return this.life > 0;
            }

            draw() {
                const alpha = (this.life / this.maxLife);
                const brightness = 0.7 + 0.3 * Math.sin(this.flicker);
                const r = Math.min(255, Math.floor(this.color[0] * brightness));
                const g = Math.min(255, Math.floor(this.color[1] * brightness));
                const b = Math.min(255, Math.floor(this.color[2] * brightness));
                const size = Math.max(1, this.baseSize * (this.life / this.maxLife));

                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
                ctx.fill();

                if (size > 1) {
                    const trailX = this.x - this.vx * 2;
                    const trailY = this.y - this.vy * 2;
                    ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, ${alpha * 0.3})`;
                    ctx.lineWidth = Math.max(1, size - 1);
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(trailX, trailY);
                    ctx.stroke();
                }

                ctx.restore();
            }
        }

        class Firework {
            constructor() {
                this.x = Math.random() * canvas.width * 0.8 + canvas.width * 0.1;
                this.y = canvas.height + Math.random() * 50;
                this.color = FIREWORK_COLORS[Math.floor(Math.random() * FIREWORK_COLORS.length)];
                this.sizeFactor = Math.random() * 1 + 0.6;
                this.speed = Math.random() * 10 * this.sizeFactor + 4 * this.sizeFactor;
                this.exploded = false;
                this.particles = [];
                const baseMin = canvas.height * 0.1;
                const baseMax = canvas.height * 0.8;
                const sizeBias = (this.sizeFactor - 0.6) / (1.6 - 0.6);
                const biasRange = (baseMax - baseMin) * 0.4;
                const minHeight = baseMin + sizeBias * biasRange;
                const maxHeight = baseMax * 0.7 + sizeBias * baseMax * 0.3;
                this.explodeHeight = Math.random() * (maxHeight - minHeight) + minHeight;
                this.trail = [];
                this.trailLength = Math.random() * 14 + 8;
            }

            update() {
                if (!this.exploded) {
                    this.y -= this.speed;
                    this.speed *= 0.95;
                    this.trail.push({x: this.x, y: this.y});
                    if (this.trail.length > this.trailLength) {
                        this.trail.shift();
                    }
                    if (this.y <= this.explodeHeight || this.speed < 0.8) {
                        this.explode();
                        return true;
                    }
                    return true;
                } else {
                    this.particles = this.particles.filter(particle => particle.update());
                    return this.particles.length > 0;
                }
            }

            explode() {
                this.exploded = true;
                const particleCount = Math.random() * 125 * this.sizeFactor + 35 * this.sizeFactor;
                for (let i = 0; i < particleCount; i++) {
                    this.particles.push(new FireworkParticle(
                        this.x, this.y, this.color, this.sizeFactor
                    ));
                }
            }

            draw() {
                if (!this.exploded) {
                    ctx.save();
                    ctx.fillStyle = `rgb(${this.color[0]}, ${this.color[1]}, ${this.color[2]})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, Math.max(2, 3 * this.sizeFactor), 0, Math.PI * 2);
                    ctx.fill();

                    for (let i = 0; i < this.trail.length; i++) {
                        const alpha = (i / this.trail.length) * 0.6;
                        const size = Math.max(1, 3 * this.sizeFactor * (i / this.trail.length));
                        const {x, y} = this.trail[i];

                        ctx.globalAlpha = alpha;
                        ctx.beginPath();
                        ctx.arc(x, y, size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    ctx.restore();
                } else {
                    this.particles.forEach(particle => particle.draw());
                }
            }
        }

        let fireworks = [];

        // 照片墙功能
        function addPhotosToWall(photos) {
            photos.forEach(photo => {
                const photoContainer = document.createElement('div');
                photoContainer.className = 'relative overflow-hidden rounded-lg shadow-lg photo-hover float';
                photoContainer.style.animationDelay = `${Math.random() * 3}s`;
                
                const img = document.createElement('img');
                img.src = photo;
                img.alt = '我们的回忆';
                img.className = 'w-full h-full object-cover';
                
                photoContainer.appendChild(img);
                photoWall.appendChild(photoContainer);
            });
            
            // 显示照片墙
            photoWall.classList.add('visible');
        }
        
        // 初始化示例照片
        function initSamplePhotos() {
            // 使用示例图片作为占位符
            const samplePhotos = [
                'https://picsum.photos/id/237/300/300',
                'https://picsum.photos/id/238/300/300',
                'https://picsum.photos/id/239/300/300',
                'https://picsum.photos/id/240/300/300',
                'https://picsum.photos/id/241/300/300',
                'https://picsum.photos/id/242/300/300'
            ];
            
            addPhotosToWall(samplePhotos);
        }
        
        // 添加照片按钮事件
        addPhotoBtn.addEventListener('click', () => {
            photoInput.click();
        });
        
        // 处理照片上传
        photoInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const photos = [];
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            photos.push(event.target.result);
                            if (photos.length === files.length) {
                                addPhotosToWall(photos);
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
        });

        // 爱情宣言卡片展开/折叠
        loveLetterCard.addEventListener('click', () => {
            loveLetterCard.classList.toggle('expanded');
            if (loveLetterCard.classList.contains('expanded')) {
                letterToggle.style.transform = 'rotate(180deg)';
            } else {
                letterToggle.style.transform = 'rotate(0)';
            }
        });
        
        // 编辑爱情宣言
        editLetterBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // 防止触发卡片折叠
            const newContent = prompt('编辑你的爱情宣言:', 
                '亲爱的静静：\n\n从2025年9月14日那天起，我的世界因为有你而变得更加精彩...');
            
            if (newContent !== null && newContent.trim() !== '') {
                // 简单处理换行
                const formattedContent = newContent.replace(/\n/g, '<br>');
                document.getElementById('letterContent').innerHTML = `
                    <p>${formattedContent}</p>
                    <p class="text-right mt-6">永远爱你的同同</p>
                    <div class="mt-6 pt-4 border-t border-love-pink border-opacity-30">
                        <button id="editLetterBtn" class="bg-love-purple hover:bg-love-pink text-white px-4 py-2 rounded transition-all text-sm">
                            <i class="fa fa-pencil mr-1"></i> 编辑我的宣言
                        </button>
                    </div>
                `;
                // 重新绑定事件
                document.getElementById('editLetterBtn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    // 这里可以再次调用编辑功能
                });
            }
        });

        // 本地音乐上传功能
        localMusicInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type === 'audio/mp3') {
                try {
                    const localUrl = URL.createObjectURL(file);
                    audio.src = localUrl;
                    audio.load();
                    audio.play().catch(() => {
                        alert('请点击播放按钮开始播放本地音乐');
                    });
                    // 隐藏iframe播放器，显示正在播放本地音乐
                    musicPlayerContainer.innerHTML = `
                        <div class="text-white text-sm p-2">
                            正在播放: ${file.name}
                        </div>
                    `;
                } catch (err) {
                    alert('加载本地音乐失败: ' + err.message);
                }
            } else {
                alert('请选择MP3格式的音乐文件');
            }
        });

        // 切换音乐播放器显示/隐藏
        togglePlayerBtn.addEventListener('click', () => {
            musicPlayerContainer.classList.toggle('hidden');
        });

        // 烟花按钮
        fireworkBtn.addEventListener('click', () => {
            const numFireworks = Math.floor(Math.random() * 7) + 2;
            for (let i = 0; i < numFireworks; i++) {
                fireworks.push(new Firework());
            }
        });

        // 移动端烟花触摸事件
        fireworkBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const numFireworks = Math.floor(Math.random() * 7) + 2;
            for (let i = 0; i < numFireworks; i++) {
                fireworks.push(new Firework());
            }
        });

        // 滚动显示动画
        function handleScrollAnimations() {
            const sections = document.querySelectorAll('section');
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                const isVisible = rect.top < window.innerHeight * 0.75 && rect.bottom > 0;
                
                if (isVisible && section.id === 'photoWall') {
                    section.classList.add('visible');
                }
            });
        }
        
        window.addEventListener('scroll', handleScrollAnimations);

        // 初始化
        try {
            // 初始化照片墙
            initSamplePhotos();
            
            // 隐藏加载指示器
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }, 1000);
        } catch (e) {
            console.error('初始化时出错:', e);
            loader.innerHTML = '<div class="text-red-500">加载出错: ' + e.message + '</div>';
        }

        // 动画循环
        let frameCount = 0;
        function animate() {
            try {
                frameCount++;

                // 清空画布
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 背景颜色
                const r = Math.min(15, frameCount / 20);
                const b = Math.min(25, frameCount / 15);
                ctx.fillStyle = `rgb(${r}, 0, ${b})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 添加内部桃心粒子
                if (frameCount % 10 === 0 && innerHearts.length < 80) {
                    innerHearts.push(new InnerHeart());
                }

                // 绘制边框桃心
                borderHearts.forEach(heart => {
                    heart.update();
                    heart.draw();
                });

                // 绘制内部桃心粒子
                innerHearts = innerHearts.filter(heart => heart.update());
                innerHearts.forEach(heart => heart.draw());

                // 绘制文字块
                wordBlocks.forEach(block => {
                    block.update();
                    block.draw();
                });

                // 绘制纪念日文字
                annivText.update();
                annivText.draw();

                // 绘制烟花
                fireworks = fireworks.filter(firework => firework.update());
                fireworks.forEach(firework => firework.draw());

                // 绘制大桃心填充
                if (frameCount > 100) {
                    ctx.save();
                    const fillAlpha = 15 + 10 * Math.sin(frameCount * 0.05);
                    ctx.globalAlpha = fillAlpha / 255;
                    ctx.fillStyle = 'rgb(255, 100, 150)';

                    ctx.beginPath();
                    ctx.moveTo(bigHeartPoints[0].x, bigHeartPoints[0].y);
                    for (let i = 1; i < bigHeartPoints.length; i++) {
                        ctx.lineTo(bigHeartPoints[i].x, bigHeartPoints[i].y);
                    }
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                }
            } catch (e) {
                console.error('动画循环出错:', e);
            }

            requestAnimationFrame(animate);
        }

        // 开始动画
        animate();
    </script>
</body>
</html>


